#include "stdio.h"
#include "math.h"

float input[500] = {0.409444148692258, 0.740943799823374, 0.878732114849915, 0.962043118065963, 0.864673030421249, 0.611392404793280, 0.206417347437748, -0.256070133292696, -0.640335843505284, -0.955506964088236, -1.12323185573100, -1.08375936790233, -0.898042259762081, -0.558943020429563, -0.0305653031811364, 0.436912916956194, 0.737826460948170, 0.891153928409338, 0.987056571305751, 0.909898950022455, 0.662122704895689, 0.324936014391275, -0.123639959411755, -0.518001817060066, -0.819490548035766, -0.943053165929522, -0.923291416719528, -0.747806130495163, -0.421806147365828, 0.0507583144872865, 0.482732090762956, 0.784352312625426, 0.901664011092637, 0.883902480273367, 0.734521567367976, 0.423191591936707, 0.0683747874912377, -0.373159032121822, -0.696077388992400, -0.894101826678033, -0.943291984440167, -0.848731102752462, -0.626998506084935, -0.303262756066490, 0.158072550169162, 0.634558442141208, 0.954733840601591, 1.06647052358182, 1.00007163594526, 0.788807402323383, 0.428007716353113, 0.0613520505064957, -0.364620226790544, -0.684260801426840, -0.816052769808160, -0.847661162443199, -0.722740293365637, -0.454876745167243, -0.191083034894020, 0.177004220412149, 0.570623047677326, 0.846803798773557, 0.896860005384914, 0.831110609902483, 0.628365249487163, 0.305700774847109, -0.0396711912415846, -0.405781006002453, -0.758775314314735, -0.931630855094263, -0.913210798864798, -0.719672711821443, -0.431605039883825, -0.0907391033586453, 0.271006540517722, 0.657182135949525, 0.995002322777031, 1.07160722082663, 0.968096462478118, 0.711548670253053, 0.397282973663982, -0.00872914683934944, -0.383428614743975, -0.712537681079922, -0.912956949372103, -0.963709666948299, -0.846882181127264, -0.570337013434070, -0.204721823421868, 0.119454534674684, 0.534375819286053, 0.940218294008229, 1.06814401616586, 0.958531356819232, 0.686709368660618, 0.336889853392219, -0.0781532416327964, -0.416771294937693, -0.701719115162722, -0.893146501592694, -0.886037696104792, -0.746935141927465, -0.469413752957733, -0.0913669884386633, 0.211344100325168, 0.561923280987331, 0.895975093382726, 1.05039002569145, 0.960214558513504, 0.704366386319466, 0.307383784878928, -0.178976331764873, -0.586923772975269, -0.897885856411903, -1.06457799151443, -1.04653996602233, -0.896648560528195, -0.557577710924718, -0.134792621676274, 0.247216179046933, 0.551205644283219, 0.856848190545594, 1.05528466879953, 0.979337612133649, 0.751886114234072, 0.371570737827139, -0.109860246974806, -0.530558208007577, -0.778427369806590, -0.940076233847607, -0.934990120725640, -0.742347166629041, -0.397772460886502, 0.0289347701333782, 0.402456586768267, 0.669931808949949, 0.865901485159896, 0.914287874299046, 0.761970563989299, 0.495714006813177, 0.101252544618960, -0.317471144239774, -0.687042390007734, -0.876243797265517, -0.989468450224188, -0.933902500384871, -0.675043724658235, -0.331779390133168, 0.0795733380344986, 0.499205750219348, 0.787208323146602, 0.935418494403540, 1.00912803121839, 0.884586176869290, 0.579306146465651, 0.158756314333162, -0.272237255850784, -0.646107034350365, -0.859976933625751, -0.903749761159478, -0.836281014035486, -0.587052680427130, -0.308885172750686, 0.0547455068652451, 0.419634482050747, 0.633616464823551, 0.744449310063253, 0.792629296955026, 0.708461001763125, 0.447852530138382, 0.114731281078978, -0.289994082086818, -0.673964250538401, -0.866189248006024, -0.880316491409009, -0.782223223716997, -0.517685090969570, -0.148315473121641, 0.237576437040852, 0.616189449902408, 0.854795810962066, 0.930970342904903, 0.866633654808648, 0.745428054200035, 0.497002275280058, 0.107792692560865, -0.287924916556696, -0.693971460889654, -0.966030632917853, -1.04345680287041, -0.958006383761023, -0.678645328415688, -0.268431513180723, 0.155828397654270, 0.559308579609246, 0.866567002448927, 0.970095045655084, 0.912544416464835, 0.749266809668146, 0.469785069707363, 0.0826168758171519, -0.266331095407935, -0.636415083484175, -0.905498220066722, -0.965274220181212, -0.830334608026132, -0.568220467231738, -0.194089215144843, 0.243853801873171, 0.639874309503358, 0.945937138712342, 1.05728703345672, 0.981177076170675, 0.732730518303814, 0.385519149454960, -0.0311267571409330, -0.433307487146817, -0.811767033462190, -1.07705742046190, -1.11753947949883, -0.971831821296837, -0.682872263686755, -0.250530328413354, 0.211811348734434, 0.574600943708928, 0.873524117450469, 1.01706622221570, 0.954038728794165, 0.739359468202028, 0.438223842426306, 0.0814165169764309, -0.316238566658090, -0.657774792779913, -0.956582822658135, -1.01002625602426, -0.840743457956170, -0.513196614772668, -0.125383222546079, 0.317046665895904, 0.659329649110583, 0.849381641241609, 0.867895815467681, 0.755737831554651, 0.507165334647945, 0.170837784452381, -0.182262743947714, -0.505713918701887, -0.766205154000546, -0.935008078397038, -0.945200900161191, -0.751883945129264, -0.449454922053202, -0.0561567040373574, 0.397089112458359, 0.767393192872924, 0.948891557523311, 0.999575296046749, 0.868847060847329, 0.547611338920536, 0.171418854247446, -0.132514511954431, -0.462551001259574, -0.709876558524025, -0.867628498484940, -0.890757283838009, -0.736857868499640, -0.448240612285219, -0.0933471073437966, 0.301013178269668, 0.648990776176460, 0.844938057988320, 0.883774343162577, 0.772383285440737, 0.488276865294854, 0.116049252304412, -0.233320708401852, -0.543384523878881, -0.745785704840896, -0.849089066847936, -0.839789926838079, -0.644877572307564, -0.282214437035260, 0.102736481388786, 0.505888866103593, 0.837008269339294, 0.992323333204342, 1.01188756905307, 0.882740635012299, 0.597051654336778, 0.167199932808229, -0.263719138207599, -0.629238025131529, -0.893895526169632, -0.991354649983497, -0.951630896230479, -0.759982869535860, -0.429762808442232, -0.0105624744347367, 0.412885750949865, 0.795743684528447, 0.991596399490358, 1.01182142682621, 0.821319088407604, 0.528840813730295, 0.117164778507433, -0.281728625467776, -0.594595686406698, -0.806303152000327, -0.879987077071039, -0.841508247141003, -0.677808605640503, -0.338008704860673, 0.121550192046693, 0.521395314457114, 0.835289208567104, 1.07207383770345, 1.04751319330869, 0.802499375431373, 0.458801810927428, 0.0168242591366702, -0.462348221685162, -0.810336575116391, -1.00091002748410, -1.04408262604787, -0.955052940987094, -0.688941923091619, -0.314105401625893, 0.128423902350308, 0.503489976530212, 0.842459646492938, 1.03594758572103, 1.02508775084008, 0.844417294793532, 0.514378960164528, 0.0536635376527301, -0.441087917727864, -0.799242235745943, -0.967434498339113, -0.959927635676248, -0.840545054178895, -0.591428149518836, -0.233846216291950, 0.147344939770173, 0.476842921894725, 0.772567419945227, 0.935533656576534, 0.912241874650348, 0.684307530164341, 0.336630834627333, -0.0858419402636267, -0.508389204542870, -0.822144006547845, -0.950961666311575, -0.943831599044338, -0.794320152832861, -0.530405107686905, -0.165425766501245, 0.266345665225246, 0.646094291310618, 0.907238925364231, 1.01555211405812, 0.961428416456665, 0.735886902004943, 0.408176241385260, 0.0274482238242377, -0.410202437562890, -0.751227618138128, -0.894896796916169, -0.893445097807004, -0.732534486836688, -0.487472870165226, -0.158953991415254, 0.208668373719845, 0.535559360033792, 0.752346325878538, 0.873492658758624, 0.837898585415696, 0.635193601798511, 0.266565878205255, -0.148561706850701, -0.525091374852375, -0.835786079038623, -0.949671485676488, -0.842641942259891, -0.587509301639500, -0.291083230241746, 0.0479163126006046, 0.409052141244044, 0.726987216945832, 0.946617547257098, 1.02498261144300, 0.953420027342562, 0.697056531077271, 0.248967118442215, -0.192812243997774, -0.600548871358460, -0.955707043213929, -1.10333533888465, -1.02770481501538, -0.769491208771393, -0.467333208741978, -0.0393706059178263, 0.412578592512598, 0.765477207179684, 0.976691673520502, 1.03673545627550, 0.934001630635116, 0.675268338551239, 0.269268225428193, -0.129843056879478, -0.531833012263140, -0.898529195212148, -1.05957429432193, -0.953414706925182, -0.665160986605501, -0.307882173757359, 0.0935756849645964, 0.498529691661553, 0.802576706993919, 0.972597616029768, 0.982635499442070, 0.849715487116125, 0.564509293629049, 0.144388913469746, -0.292804208562113, -0.694434796242299, -1.02129901392703, -1.14622436492461, -1.02114130740648, -0.749417988083046, -0.348835767419155, 0.0495532535349257, 0.506746733061142, 0.858234112309079, 1.04974552199657, 1.06509428529837, 0.920709322023382, 0.597268749832066, 0.194568780551803, -0.254865659604510, -0.634602572758630, -0.910695928247567, -1.01156796261270, -0.918068548380572, -0.649064494231439, -0.264348443771121, 0.113226371880319, 0.490251955681218, 0.791169330217687, 0.959528084380521, 0.932414700789853, 0.707586401474988, 0.395744958346545, 0.0304763259221100, -0.392661402480768, -0.737451852626253, -0.973797196777640, -1.08888418269847, -0.982466316824524, -0.635831091134798, -0.171481414585474, 0.251414290320902, 0.599038985595649, 0.880307275874039, 1.03208153660584, 0.992499468506030, 0.788750320171433, 0.521051274315375, 0.131659957413566, -0.327078471708419, -0.720087138992026, -0.934662886630019, -1.06186488144728, -0.989645180677074, -0.695929217772518, -0.273492530613692, 0.138488236761010, 0.497485208764236, 0.804287361547951, 0.944924465712737, 0.893659199165092, 0.685946030742948, 0.380671517095379, -0.0135772410754107, -0.412434600390991, -0.739057567782752, -0.919088233479242, -0.983614199484365, -0.898853868477392, -0.579305488141128, -0.136411393445615, 0.302307136044603, 0.673442831841907, 0.954402512979457, 1.05744558382679, 0.962226593291454, 0.706683983619630, 0.340244330851053, -0.0703710450937111, -0.478565927365445}; 

#define SAMPLE_RATE 24000.0
#define PI 3.14159265359

// Input samples
float LeftInput; 
float RightInput;

// Corrupted samples
float LeftInputCorrupted; 
float RightInputCorrupted;

// Filtered samples
float LeftOutputFiltered; 
float RightOutputFiltered;


// TODO: 0. Define your own global coefficients for filtering
#define BUFFER_SIZE     2
//define the buffer size

#define INDEX(CURRENT)  ((CURRENT) + BUFFER_SIZE) % BUFFER_SIZE
// if an index is negative, a specified position from the end of the array will be returned.
// e.g. given an array x[8], x[INDEX(-1)] and x[INDEX(7)] both refer to x[7].

static float A = 3E8;           // noise amplitude
static float BW = 0.1 * PI;     // Bandwidth
static float F = 550;           // Central frequency

static double alpha, beta;      // filter coefficients
static double coeff_1, coeff_2;

static float xBufferL[BUFFER_SIZE] = {0.0};
static float xBufferR[BUFFER_SIZE] = {0.0};
// input buffer (Left and Right)

static float yBufferL[BUFFER_SIZE] = {0.0};
static float yBufferR[BUFFER_SIZE] = {0.0};
// output buffer (Left and Right)


void FilterCoeff(void) {
    // TODO: 1. Initialise the filter coefficients
    //   You should write this function so the filter centre frequency and
    //   bandwidth can be easily changed.

    beta = cos(F * 2 * PI / SAMPLE_RATE);
    
    double cosine = cos(BW);
    alpha = 1/cosine - sqrt(1/(cosine*cosine) - 1);

    coeff_1 = (1 + alpha) / 2;
    coeff_2 = (1 + alpha) * beta;

    printf("alpha=%f\nbeta=%f\n", alpha, beta);
}


void AddSinus(void) {
    // TODO: 2. Add the sinusoidal disturbance to the input samples

    static int index = 0;
    // declaring as static keeps 'index' between invocations

    float disturbance = A * cos(F * 2 * PI * index / SAMPLE_RATE);
    // sinusoid wave

    index++;
    index = index % (int)SAMPLE_RATE;
    // 'index' counts from 0 up to SAMPLE_RATE and starts at 0 again.
    // in case of 'index' overflow

    LeftInputCorrupted = LeftInput + disturbance;
    RightInputCorrupted = RightInput + disturbance;
}

void NotchFilter(void) {
    // TODO: 3. Filter the corrupted samples

    static int current = 0;

    LeftOutputFiltered  = coeff_1 * (LeftInputCorrupted  - 2 * beta * xBufferL[INDEX(current-1)] + xBufferL[INDEX(current-2)]) + coeff_2 * yBufferL[INDEX(current-1)] - alpha * yBufferL[INDEX(current-2)];

    xBufferL[current] = LeftInputCorrupted;

    yBufferL[current] = LeftOutputFiltered;

    current++;
    current = current % BUFFER_SIZE;
}

int main(void) {
    // TODO: 3. Filter the corrupted samples

    FilterCoeff();


    for (int indexMain = 0; indexMain < 500; ++indexMain) {
        LeftInputCorrupted = input[indexMain];
        
        NotchFilter();

        printf("%f\t", LeftOutputFiltered);
    }

    return 0;
}
